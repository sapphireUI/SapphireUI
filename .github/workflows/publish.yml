name: Publish SapphireUI to PyPI

on:
  release:
    types: [published]

jobs:
  publish:
    name: Build & Publish to PyPI
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        run: pip install uv

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        # '--trusted-publishing' accepts one of: automatic, always, never
        # Use 'automatic' to let the CLI determine whether publishing is trusted
        # (or change to 'always' to skip any confirmation prompts in CI).
        run: uv publish --trusted-publishing automatic
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Verify publication (install local wheel)
        # Install the locally-built wheel from dist/ for robust CI verification
        run: |
          PACKAGE_NAME="sapphireui"
          RAW_VERSION="${{ github.event.release.tag_name }}"
          # If the release tag includes the package name (e.g. 'sapphireui0.4.0' or 'sapphireui-v0.4.0'),
          # strip the package name. Then strip a leading '-' or 'v' if present.
          VERSION="${RAW_VERSION#${PACKAGE_NAME}}"
          VERSION="${VERSION#-}"
          VERSION="${VERSION#v}"
          if [ -z "$VERSION" ]; then
            VERSION="$RAW_VERSION"
          fi

          echo "Installing local wheel matching *${VERSION}* for verification"
          # Prefer a wheel that includes the version in the filename; fall back to any wheel
          set -o pipefail
          if ls dist/*${VERSION}*.whl 1> /dev/null 2>&1; then
            pip install dist/*${VERSION}*.whl
          else
            pip install dist/*.whl
          fi

          # Use importlib.metadata to read the installed distribution version
          python - <<'PY'
          from importlib.metadata import version, PackageNotFoundError
          try:
              print(version('sapphireui'))
          except PackageNotFoundError:
              raise SystemExit('sapphireui distribution not found after install')
          PY

        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Clean up
        run: uv clean
